<html>
<head>
    <style>
        body {
            background-color: black;
            text-align: center;
        }
        #pongCanvas {
            background-color: black;
            border: solid #00FF00;
            top: 6.25%;
        }
        h1 {
            color: #00FF00;
            font-family: sans-serif;
        }
        p {
            color: white;
        }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    </head>
    <body>
        <h1>PONG Revised!!</h1>
    <canvas id="pongCanvas" width="800" height="500">
    Your browser does not support the HTML5 canvas.
    </canvas>
    <script>
        /* ----------------------SOCKET.IO CONNECTION------------------ */         
        
        var socket = io();
        var clientNumber = null;
        
        // test connection to server
        socket.on('client number', function(msg) {
            if (clientNumber == null) {
                clientNumber = msg;
            }
        });
        
        /* ---------------------CANVAS AND GAME-----------------------*/
        
        window.onload = function(){
            var canvas = document.getElementById("pongCanvas");
        
            if (canvas && canvas.getContext) {
                var ctx = canvas.getContext("2d");
            }
        
            document.onkeydown = function(e) {
                switch (e.keyCode) {
                    case 37:
//                      alert('left');
                        break;
                    case 38:
//                      alert('up');
                        paddle1y -= 10;
                        break;
                    case 39:
//                      alert('right');
                        break;
                    case 40:
                        paddle1y += 10;
//                      alert('down');
                        break;
                }
            };

            var mousePos = {y:0}; 
            var p2Pos = 25;
            var mousePosNew = null;
            var message =  null;
            

            function getMousePos(canvas, evt) {
                var rect = canvas.getBoundingClientRect();
                return {
                    x: Math.round((evt.clientX-rect.left)/(rect.right-rect.left)*canvasWidth),
                    y: Math.round((evt.clientY-rect.top)/(rect.bottom-rect.top)*canvasHeight)
                };
            }

            canvas.addEventListener('mousemove', function(evt) {
                message = 'Mouse position: ' + getMousePos(canvas, evt).y;
                
                // sends mouse y position data to server
                socket.emit('player mouse position', {player: clientNumber, position:getMousePos(canvas, evt).y});
            }, false);
            
            //gets paddle positions from server
            socket.on('paddles position', function(msg) {
                mousePos.y = msg.paddle1;
                paddle1y = msg.paddle1;
                p2Pos = msg.paddle2;
            });

            var canvasHeight = ctx.canvas.height;
            var canvasWidth = ctx.canvas.width; 
        
            var ballx = 400;
            var bally = 250;
        
            var y = 1;
            var x = 1;        
        
            var tick = 1;
            
            function Paddle(){
                this.x = 10;
                this.y = 25;
                this.length = 100;
                this.width = 10;

                this.draw = function(ctx){
                    //drawing paddle1
                    ctx.strokeStyle = "#00FF00";
                    ctx.fillStyle = "#00FF00";
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.fillRect(this.x, this.y, this.width, this.length);
                }

                this.move = function () {
                    
                }
            }

            function Ball(){
                this.speed = 3;
                this.angle = Math.floor(Math.random() * 360) + 1;

                this.draw = function(ctx){
                    //drawing the ball.
                    ctx.strokeStyle = "#00FF00";
                    ctx.fillStyle = "#00FF00";
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(ballx, bally, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.stroke();
                }

                this.move = function () {
                    // body...
                }

                function changeBallx(){
                    ballx = ballx + (x * ballVelocity * Math.cos(ballAngle));
                }
        
                function changeBally(){
                    bally = bally + (y * ballVelocity * Math.sin(ballAngle));
                }
        
                function reflectBallx(){
                    x = x * -1;
                }
        
                function reflectBally(){
                    y = y * -1
                }
            }
        
            function draw(){                                                
            
                //clearing the screen
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, 100000, 10000);
            
                //drawing the top wall
                ctx.strokeStyle = "#00FF00";
                ctx.fillStyle = "#00FF00";
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.fillRect(0, 0, canvasWidth, 20);
            
                //drawing the bottom wall
                ctx.strokeStyle = "#00FF00";
                ctx.fillStyle = "#00FF00";
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.fillRect(0, canvasHeight-20, canvasWidth, 20);
            
                //drawing the middle lines
                for(var i=0; i < 500; i = i + 20){
                    ctx.strokeStyle = "#green";
                    ctx.fillStyle = "#green";
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.fillRect(400, i, 1, 10);
                }
            
                //write the mouse positio on the canvas
                ctx.font = '18pt Calibri';
                ctx.fillStyle = '#00FF00';
                ctx.fillText(message, 300,50);
            
                //drawing paddle2
                ctx.strokeStyle = "#00FF00";
                ctx.fillStyle = "#00FF00";
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.fillRect(canvasWidth - 10 - paddle1x, p2Pos, paddle1Width, paddle1Length);
                
            }
        
            function game(){
                if (mousePos != null){
                    if (mousePosNew != mousePos){
                        paddle1y = mousePos.y;
                        mousePosNew =mousePos;
                    }
                }

//              document.writeln("game is being called");
                if((ballx <= 0) || (ballx >= 800)){
//                  alert("ball hit x boundaries");
                    reflectBallx();
                }
            
                if((bally <= 20) || (bally >= 480)){
//                  alert("ball hit y boundaries");
                    reflectBally();
                }
            
                //ball detection with paddles
                if(ballx <= (paddle1x + paddle1Width) && (bally >= paddle1y && bally <= (paddle1y + paddle1Length))){
                    console.log("py: " + paddle1y + " bally: " + bally)
                    if (bally < paddle1y + 1/3*paddle1Length){
                        console.log("upper third hit")
                    } else if ((bally > paddle1y + 1/3*paddle1Length) &&(bally < paddle1y + 2/3*paddle1Length)){
                        console.log("middle third hit")
                    } else{
                        console.log("lower third hit")
                    }

                    reflectBallx();
//                  alert("ball touched");
                }
                
                if(ballx >= (canvasWidth - 10 - paddle1x) && (bally >= p2Pos && bally <= (p2Pos + paddle1Length))){
                    reflectBallx();
//                  alert("ball touched");
                }
                
                //make sure paddles doesn't go off the screen
                if (paddle1y < paddle1Length / 2) {
                    paddle1y = paddle1Length / 2;                
                } 
                
                if (p2Pos < paddle1Length / 2) {
                    p2Pos = paddle1Length / 2;                
                }

                if (paddle1y > canvasHeight - paddle1Length - paddle1Length / 2){
                    paddle1y = canvasHeight - paddle1Length - paddle1Length / 2;
                }
                
                if (p2Pos > canvasHeight - paddle1Length - paddle1Length / 2){
                    p2Pos = canvasHeight - paddle1Length - paddle1Length / 2;
                }
            
                changeBallx();
                changeBally();
            
                draw();
                
                // testing
                if (clientNumber == 1) {
                    socket.emit('ball pos',{x:ballx, y:bally});
                }
                
                socket.on('p2 ball pos', function(msg) {
                    if (clientNumber > 1) {
                        ballx = msg.x;
                        bally = msg.y;
                    }
                })

                ++tick;
                if (tick == 500){
            	   tick = 1;
            	   console.log("ballx: " + ballx + " ; bally: " + bally);
                }
            
            }
        
            setInterval(game, 5);
        }
    </script>  
    </body>
</html>